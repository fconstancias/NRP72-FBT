---
title: " Fig. 1 - S1 - chicken manuscript "
author: "Florentin Constancias"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document: 
    toc: yes
    keep_md: yes
---

```{r setup, include=FALSE}
rm(list = ls())
gc()
options(java.parameters = "-Xmx80000m")
```

```{r setup2, include=FALSE}

##knitr::opts_chunk$set(cache=TRUE)
##knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(dev = "ragg_png") # https://ragg.r-lib.org/index.html
knitr::opts_chunk$set(fig.width = 6) #https://r4ds.had.co.nz/graphics-for-communication.html#figure-sizing
knitr::opts_chunk$set(fig.asp = 0.618)
knitr::opts_chunk$set(fig.show = "hold")
knitr::opts_chunk$set(fig.show = "70%")
knitr::opts_chunk$set(fig.align = "center")
```

```{r packages, results=FALSE, warning=FALSE}
#install.packages("tidyverse")
require(tidyverse); packageVersion("tidyverse")
require(phyloseq); packageVersion("phyloseq")
require(microViz); packageVersion("microViz")

```

```{r sourcing, warning=FALSE, results=FALSE , message= FALSE}
source("https://raw.githubusercontent.com/fconstancias/DivComAnalyses/master/R/phyloseq_taxa_tests.R") 
source("https://raw.githubusercontent.com/fconstancias/DivComAnalyses/master/R/phyloseq_alpha.R") 
source("https://raw.githubusercontent.com/fconstancias/DivComAnalyses/master/R/phyloseq_beta.R") 
source("https://raw.githubusercontent.com/fconstancias/DivComAnalyses/master/R/phyloseq_heatmap.R")
# source("https://raw.githubusercontent.com/fconstancias/metabaRpipe-source/master/Rscripts/functions.R")
source("https://raw.githubusercontent.com/fconstancias/DivComAnalyses/master/R/phyloseq_normalisation.R") 
source("https://raw.githubusercontent.com/fconstancias/DivComAnalyses/master/R/phyloseq_varia.R")


'%!in%' <- function(x,y)!('%in%'(x,y))

```

```{r}
out_pptx = "~/Desktop/16S-chick_S1.pptx"
out_xlsx = "~/Desktop/16S-chick_S1.xlsx"
```

```{r}
load(url("https://github.com/fconstancias/NRP72-FBT/blob/master/Figures/Rastetics.Rdata?raw=true"))
```

# load data:

```{r}
"data/processed/16S/16S_working_phyloseq.RDS" %>% 
  here::here() %>% 
  readRDS()  %>% 
  subset_samples(Enrichment == "NotEnriched") %>%
  subset_samples(Experiment %in% c("Continuous", "Cecum")) %>%
  subset_samples(Day_of_Treatment > -6 & Day_of_Treatment <= 30 | Reactor == "DONOR") %>% 
  subset_samples(Model == "Chicken") %>% 
  subset_samples(Reactor != "CR" & Model2 == "Chicken1" | Model2 == "Chicken2" & Reactor %in% c("TR2", "TR3", "TR4", "TR5", "TR6", "TR7", "CR", "DONOR")) %>% 
  subset_samples(Reactor != "IR") -> ps_filtered
```

# Rarefraction

```{r}
min_sample_size = 3738

ps_filtered %>%
  filter_taxa(function(x) sum(x > 0) > 0, TRUE) %>% 
  rarefy_even_depth(sample.size = min_sample_size, rngseed = 123)  -> ps_rare

ps_filtered %>%
  filter_taxa(function(x) sum(x > 0) > 0, TRUE) %>% 
  prune_samples(sample_sums(.)>= min_sample_size, .) -> ps_fil
```

## Before Treatment:

Obj: compare donor microbiota and pre-treatment / CR - heatmap
day -2, -1, 0
top feces

Identify last 3 samples including 0:

```{r}
ps_rare %>%
  filter_taxa(function(x) sum(x > 0) > 0, TRUE) %>% 
  subset_samples(Day_of_Treatment <= 0 & Day_of_Treatment > -4 | Reactor %in% c("DONOR")) -> before_treat # %>% 

before_treat %>% 
  sample_data() %>% 
  data.frame() %>% 
  group_by(Model, Model2, Reactor_Treatment_Dose_fermentation) %>% 
  arrange(Day_of_Treatment) %>% 
  slice(tail(row_number(), 4)) %>% 
  pull(sample_names) %>% 
  as.character() -> before_treat_samples
```

```{r}
ps_rare %>%
  filter_taxa(function(x) sum(x > 0) > 0, TRUE) %>% 
  subset_samples(sample_name %in% c(before_treat_samples)) -> before_treat
# prune_samples(x = ., samples  %in% c(before_treat_samples)) -> before_treat #%>% 
# rarefy_even_depth(sample.size = min_sample_size, rngseed = 123) %>%
# subset_samples(Day_of_Treatment %in% c(-2, -1, 0) | Reactor %in% c("DONOR")) -> before_treat # %>% 
# subset_samples(Reactor %!in%c("IR")) %>% 
# subset_samples() -> before_treat
```

### ASV:

top ASV  per fecal samples in each donors:

```{r}
ntax = 20 

before_treat %>%
  subset_samples(Reactor == "DONOR") %>% 
  physeq_most_abundant(group_var = "Model2",
                       ntax = ntax,
                       tax_level = "Strain") -> top_ASV_donor_feces

# top_ASV_donor_feces

before_treat %>%
  physeq_most_abundant(group_var = "Reactor",
                       ntax = ntax,
                       tax_level = "Strain") -> top_ASV_group

# top_ASV_group
```

#### top feces: 

```{r}
before_treat %>%
  filter_taxa(function(x) sum(x > 0) > 0, TRUE) %>% 
  transform_sample_counts(function(x) x/sum(x) * 100) %>%
  subset_taxa(Strain %in% top_ASV_donor_feces) %>% # extract only the taxa to display - after percentage normalisation
  phyloseq_ampvis_heatmap(physeq = ., tax_aggregate = "Species",
                          transform = FALSE,
                          plot_values = FALSE,
                          facet_by = c("Model2", "Model", "Fermentation","Reactor_Treatment_Dose"),
                          group_by = "Day_of_Treatment",#"sample_name",
                          ntax = Inf
  ) -> pre_speces_feces

pre_speces_feces$data %>% 
  mutate(Abundance = na_if(Abundance, 0)) %>% 
  mutate(Fermentation = Fermentation %>%  as.character() %>%  replace_na(., "NA")) %>% 
  mutate(Fermentation = factor(Fermentation, levels = c("NA", 1, 2))) -> pre_speces_feces$data 

pre_speces_feces + 
  facet_grid(Model ~  Model2 + Fermentation + Reactor_Treatment_Dose, scales = "free", space = "free") +
  scale_color_manual(values = c("#31a354", "orange", 
                                "#f03b20"), drop = FALSE, na.value = 'transparent') -> pre_speces_feces
# scale_fill_viridis_c(breaks = c(0,  0.01, 1, 10, 25, 50, 75, 100),
# labels = c(0,  0.01, 1, 10, 25,  50, 75, 100),
# trans = scales::pseudo_log_trans(sigma = 0.9),
# na.value = 'transparent') -> pre_speces

pre_speces_feces

# pre_speces %>% 
#   ggsave(file="~/Desktop/16S-chick_S1.svg", plot=., width=10, height=8)
```

Representative of those:

```{r}
# before_treat %>%
#   filter_taxa(function(x) sum(x > 0) > 0, TRUE) %>% 
#   transform_sample_counts(function(x) x/sum(x) * 100) %>%
#   subset_taxa(Strain %in% top_ASV_donor_feces) %>%
#   ps_arrange(Day_of_Treatment) %>% 
#   speedyseq::psmelt() %>%
#   # group_by(Sample, Day_of_Treatment, Fermentation, Model, Model2, Reactor_Treatment_Dose) %>%
#   group_by(sample_names, Model, Model2, Day_of_Treatment, Fermentation , Reactor_Treatment_Dose) %>% 
#   summarise(coverage = sum(Abundance)) %>%
#   ungroup() %>%
#   mutate(Day_of_Treatment = as.double(Day_of_Treatment)) %>%
#   mutate_at(vars(Day_of_Treatment), ~replace_na(., 0)) %>% 
#       # arrange(Day_of_Treatment) %>%
#   # group_by(sample_names, Model, Model2, Day_of_Treatment, Reactor_Treatment_Dose_fermentation) %>% 
#   #      summarise(count = length(coverage)) %>% 
#   # ggpubr::ggdotchart(., x = "Day_of_Treatment", y = "coverage",
#   #                    fill = "grey20", color = "grey5", width = 0.8, add = "segments") + #,
#   # ylab = "gdh copies / 10^10 cells \n", xlab = "") +
#   # facet_grid(variable ~ ., scales = "free") +
#   ggplot(., aes(x=Day_of_Treatment, y=coverage)) +
#   geom_point() + ggpubr::rotate_x_text(60)  +
#   theme_light() + 
#   # facet_grid(Model ~  Model2 + Reactor_Treatment_Dose_fermentation,  scales = "fixed", space = "fixed", drop = TRUE) -> toto
#   facet_grid(Model ~  Model2 + Fermentation + Reactor_Treatment_Dose, scales = "free", space = "free", drop = FALSE) -> toto
# 
# toto



before_treat %>%
  filter_taxa(function(x) sum(x > 0) > 0, TRUE) %>% 
  transform_sample_counts(function(x) x/sum(x) * 100) %>%
  subset_taxa(Strain %in% top_ASV_donor_feces) %>%
  ps_arrange(Day_of_Treatment) %>% 
  speedyseq::psmelt() %>%
  # group_by(Sample, Day_of_Treatment, Fermentation, Model, Model2, Reactor_Treatment_Dose) %>%
  group_by(sample_names, Model, Model2, Day_of_Treatment, Fermentation , Reactor_Treatment_Dose) %>% 
  summarise(coverage = sum(Abundance)) %>%
  ungroup() %>%
  mutate(Day_of_Treatment = as.double(Day_of_Treatment)) %>%
  mutate_at(vars(Day_of_Treatment), ~replace_na(., 0)) %>%
  arrange(Day_of_Treatment) %>%
  # group_by(sample_names, Model, Model2, Day_of_Treatment, Reactor_Treatment_Dose_fermentation) %>% 
  #      summarise(count = length(coverage)) %>% 
  ggpubr::ggbarplot(., x = "Day_of_Treatment", y = "coverage",
                    fill = "grey20", color = "grey5", width = 0.8, add = "segments") + #,
  # ylab = "gdh copies / 10^10 cells \n", xlab = "") +
  # facet_grid(variable ~ ., scales = "free") +
  # ggplot(., aes(x=Day_of_Treatment, y=coverage)) +
  # geom_point() +
  ggpubr::rotate_x_text(60)  +
  theme_light() + 
  facet_grid(Model ~  Model2 + Fermentation + Reactor_Treatment_Dose, scales = "free", space = "free") -> repr_top_ASV_donor_feces
# facet_grid(Model ~  Model2 + Reactor_Treatment_Dose_fermentation,  scales = "fixed", space = "fixed", drop = TRUE) -> toto
# facet_grid(Model ~  Model2 + Fermentation + Reactor_Treatment_Dose, scales = "free", space = "free", drop = FALSE) -> toto
# facet_wrap()

repr_top_ASV_donor_feces
```

#### top top_ASV_group: 

```{r}
before_treat %>%
  filter_taxa(function(x) sum(x > 0) > 0, TRUE) %>% 
  transform_sample_counts(function(x) x/sum(x) * 100) %>%
  subset_taxa(Strain %in% top_ASV_group) %>% # extract only the taxa to display - after percentage normalisation
  phyloseq_ampvis_heatmap(physeq = ., tax_aggregate = "Species",
                          transform = FALSE,
                          plot_values = FALSE,
                          facet_by = c("Model2", "Model", "Fermentation","Reactor_Treatment_Dose"),
                          group_by = "Day_of_Treatment",#"sample_name",
                          ntax = Inf
  ) -> pre_speces_group

pre_speces_group$data %>% 
  mutate(Abundance = na_if(Abundance, 0)) %>% 
  mutate(Fermentation = Fermentation %>%  as.character() %>%  replace_na(., "NA")) %>% 
  mutate(Fermentation = factor(Fermentation, levels = c("NA", 1, 2))) -> pre_speces_group$data 

pre_speces_group + 
  facet_grid(Model ~   Model2 + Fermentation + Reactor_Treatment_Dose, scales = "free", space = "free") +
  scale_color_manual(values = c("#31a354", "orange", 
                                "#f03b20"), drop = FALSE, na.value = 'transparent') -> pre_speces_group
# scale_fill_viridis_c(breaks = c(0,  0.01, 1, 10, 25, 50, 75, 100),
# labels = c(0,  0.01, 1, 10, 25,  50, 75, 100),
# trans = scales::pseudo_log_trans(sigma = 0.9),
# na.value = 'transparent') -> pre_speces

pre_speces_group

# pre_speces %>% 
#   ggsave(file="~/Desktop/16S-chick_S1.svg", plot=., width=10, height=8)
```

Representative of those:

```{r}
# before_treat %>%
#   filter_taxa(function(x) sum(x > 0) > 0, TRUE) %>% 
#   transform_sample_counts(function(x) x/sum(x) * 100) %>%
#   subset_taxa(Strain %in% top_ASV_donor_feces) %>%
#   ps_arrange(Day_of_Treatment) %>% 
#   speedyseq::psmelt() %>%
#   # group_by(Sample, Day_of_Treatment, Fermentation, Model, Model2, Reactor_Treatment_Dose) %>%
#   group_by(sample_names, Model, Model2, Day_of_Treatment, Fermentation , Reactor_Treatment_Dose) %>% 
#   summarise(coverage = sum(Abundance)) %>%
#   ungroup() %>%
#   mutate(Day_of_Treatment = as.double(Day_of_Treatment)) %>%
#   mutate_at(vars(Day_of_Treatment), ~replace_na(., 0)) %>% 
#       # arrange(Day_of_Treatment) %>%
#   # group_by(sample_names, Model, Model2, Day_of_Treatment, Reactor_Treatment_Dose_fermentation) %>% 
#   #      summarise(count = length(coverage)) %>% 
#   # ggpubr::ggdotchart(., x = "Day_of_Treatment", y = "coverage",
#   #                    fill = "grey20", color = "grey5", width = 0.8, add = "segments") + #,
#   # ylab = "gdh copies / 10^10 cells \n", xlab = "") +
#   # facet_grid(variable ~ ., scales = "free") +
#   ggplot(., aes(x=Day_of_Treatment, y=coverage)) +
#   geom_point() + ggpubr::rotate_x_text(60)  +
#   theme_light() + 
#   # facet_grid(Model ~  Model2 + Reactor_Treatment_Dose_fermentation,  scales = "fixed", space = "fixed", drop = TRUE) -> toto
#   facet_grid(Model ~  Model2 + Fermentation + Reactor_Treatment_Dose, scales = "free", space = "free", drop = FALSE) -> toto
# 
# toto



before_treat %>%
  filter_taxa(function(x) sum(x > 0) > 0, TRUE) %>% 
  transform_sample_counts(function(x) x/sum(x) * 100) %>%
  subset_taxa(Strain %in% top_ASV_group) %>%
  ps_arrange(Day_of_Treatment) %>% 
  speedyseq::psmelt() %>%
  # group_by(Sample, Day_of_Treatment, Fermentation, Model, Model2, Reactor_Treatment_Dose) %>%
  group_by(sample_names, Model, Model2, Day_of_Treatment, Fermentation , Reactor_Treatment_Dose) %>% 
  summarise(coverage = sum(Abundance)) %>%
  ungroup() %>%
  mutate(Day_of_Treatment = as.double(Day_of_Treatment)) %>%
  # mutate_at(vars(Day_of_Treatment), ~replace_na(., 0)) %>%
  arrange(Day_of_Treatment) %>%
  # group_by(sample_names, Model, Model2, Day_of_Treatment, Reactor_Treatment_Dose_fermentation) %>% 
  #      summarise(count = length(coverage)) %>% 
  ggpubr::ggbarplot(., x = "Day_of_Treatment", y = "coverage",
                    fill = "grey20", color = "grey5", width = 0.8, add = "segments") + #,
  # ylab = "gdh copies / 10^10 cells \n", xlab = "") +
  # facet_grid(variable ~ ., scales = "free") +
  # ggplot(., aes(x=Day_of_Treatment, y=coverage)) +
  # geom_point() +
  ggpubr::rotate_x_text(60)  +
  theme_light() + 
  facet_grid(Model ~  Model2 + Fermentation + Reactor_Treatment_Dose, scales = "free", space = "free") -> repr_top_ASV_pre_speces_group
# facet_grid(Model ~  Model2 + Reactor_Treatment_Dose_fermentation,  scales = "fixed", space = "fixed", drop = TRUE) -> toto
# facet_grid(Model ~  Model2 + Fermentation + Reactor_Treatment_Dose, scales = "free", space = "free", drop = FALSE) -> toto
# facet_wrap()

repr_top_ASV_pre_speces_group
```
### Family:

top   per fecal samples in each donors:

```{r}
ntax = 6 

before_treat %>%
  subset_samples(Reactor == "DONOR") %>% 
  physeq_most_abundant(group_var = "Model2",
                       ntax = ntax,
                       tax_level = "Family") -> top_fam_donor_feces

# top_ASV_donor_feces

before_treat %>%
  physeq_most_abundant(group_var = "Reactor",
                       ntax = ntax,
                       tax_level = "Family") -> top_fam_group

# top_ASV_group
```


```{r}
before_treat %>%
  filter_taxa(function(x) sum(x > 0) > 0, TRUE) %>% 
  # subset_samples(Model2 == "Chicken1") %>% 
  # subset_samples(Reactor == "DONOR") %>%  sample_data() %>%  data.frame()
  speedyseq::tax_glom(taxrank = "Family") %>%
  transform_sample_counts(function(x) x/sum(x) * 100) %>%
  subset_taxa(Family %in% top_fam_donor_feces) %>% # extract only the taxa to display - after percentage normalisation
  
  phyloseq_ampvis_heatmap(physeq = ., tax_aggregate = "Family",
                          transform = FALSE,
                          plot_values = FALSE,
                          facet_by = c("Model2", "Model", "Fermentation","Reactor_Treatment_Dose"),
                          group_by = "Day_of_Treatment",#"sample_name",
                          ntax = Inf
  ) -> pre_Family

pre_Family$data %>% 
  mutate(Abundance = na_if(Abundance, 0)) %>% 
  mutate(Fermentation = Fermentation %>%  as.character() %>%  replace_na(., "NA")) %>% 
  mutate(Fermentation = factor(Fermentation, levels = c("NA", 1, 2))) -> pre_Family$data 


pre_Family + 
  facet_grid(Model ~ Model2 + Fermentation + Reactor_Treatment_Dose, scales = "free", space = "free") +
  scale_color_manual(values = c("#31a354", "orange", 
                                "#f03b20"), drop = FALSE, na.value = 'transparent') -> pre_Family


pre_Family
```
```{r}

before_treat %>%
  filter_taxa(function(x) sum(x > 0) > 0, TRUE) %>% 
  transform_sample_counts(function(x) x/sum(x) * 100) %>%
  subset_taxa(Family %in% top_fam_donor_feces) %>% 
  ps_arrange(Day_of_Treatment) %>% 
  speedyseq::psmelt() %>%
  # group_by(Sample, Day_of_Treatment, Fermentation, Model, Model2, Reactor_Treatment_Dose) %>%
  group_by(sample_names, Model, Model2, Day_of_Treatment, Fermentation , Reactor_Treatment_Dose) %>% 
  summarise(coverage = sum(Abundance)) %>%
  ungroup() %>%
  mutate(Day_of_Treatment = as.double(Day_of_Treatment)) %>%
  # mutate_at(vars(Day_of_Treatment), ~replace_na(., 0)) %>%
  arrange(Day_of_Treatment) %>%
  # group_by(sample_names, Model, Model2, Day_of_Treatment, Reactor_Treatment_Dose_fermentation) %>% 
  #      summarise(count = length(coverage)) %>% 
  ggpubr::ggbarplot(., x = "Day_of_Treatment", y = "coverage",
                    fill = "grey20", color = "grey5", width = 0.8, add = "segments") + #,
  # ylab = "gdh copies / 10^10 cells \n", xlab = "") +
  # facet_grid(variable ~ ., scales = "free") +
  # ggplot(., aes(x=Day_of_Treatment, y=coverage)) +
  # geom_point() +
  ggpubr::rotate_x_text(60)  +
  theme_light() + 
  facet_grid(Model ~   Model2 + Fermentation + Reactor_Treatment_Dose, scales = "free", space = "free") -> repr_top_Fam_donor_feces
# facet_grid(Model ~  Model2 + Reactor_Treatment_Dose_fermentation,  scales = "fixed", space = "fixed", drop = TRUE) -> toto
# facet_grid(Model ~  Model2 + Fermentation + Reactor_Treatment_Dose, scales = "free", space = "free", drop = FALSE) -> toto
# facet_wrap()

repr_top_Fam_donor_feces
```


```{r}
before_treat %>%
  filter_taxa(function(x) sum(x > 0) > 0, TRUE) %>% 
  # subset_samples(Model2 == "Chicken1") %>% 
  # subset_samples(Reactor == "DONOR") %>%  sample_data() %>%  data.frame()
  speedyseq::tax_glom(taxrank = "Family") %>%
  transform_sample_counts(function(x) x/sum(x) * 100) %>%
  subset_taxa(Family %in% top_fam_group) %>% # extract only the taxa to display - after percentage normalisation
  
  phyloseq_ampvis_heatmap(physeq = ., tax_aggregate = "Family",
                          transform = FALSE,
                          plot_values = FALSE,
                          facet_by = c("Model2", "Model", "Fermentation","Reactor_Treatment_Dose"),
                          group_by = "Day_of_Treatment",#"sample_name",
                          ntax = Inf
  ) -> pre_Family_grp

pre_Family_grp$data %>% 
  mutate(Abundance = na_if(Abundance, 0)) %>% 
  mutate(Fermentation = Fermentation %>%  as.character() %>%  replace_na(., "NA")) %>% 
  mutate(Fermentation = factor(Fermentation, levels = c("NA", 1, 2))) -> pre_Family_grp$data 


pre_Family_grp + 
  facet_grid(Model ~ Model2 + Fermentation + Reactor_Treatment_Dose, scales = "free", space = "free") +
  scale_color_manual(values = c("#31a354", "orange", 
                                "#f03b20"), drop = FALSE, na.value = 'transparent') -> pre_Family_grp


pre_Family_grp
```
```{r}

before_treat %>%
  filter_taxa(function(x) sum(x > 0) > 0, TRUE) %>% 
  transform_sample_counts(function(x) x/sum(x) * 100) %>%
  subset_taxa(Family %in% top_fam_group) %>% 
  ps_arrange(Day_of_Treatment) %>% 
  speedyseq::psmelt() %>%
  # group_by(Sample, Day_of_Treatment, Fermentation, Model, Model2, Reactor_Treatment_Dose) %>%
  group_by(sample_names, Model, Model2, Day_of_Treatment, Fermentation , Reactor_Treatment_Dose) %>% 
  summarise(coverage = sum(Abundance)) %>%
  ungroup() %>%
  mutate(Day_of_Treatment = as.double(Day_of_Treatment)) %>%
  # mutate_at(vars(Day_of_Treatment), ~replace_na(., 0)) %>%
  arrange(Day_of_Treatment) %>%
  # group_by(sample_names, Model, Model2, Day_of_Treatment, Reactor_Treatment_Dose_fermentation) %>% 
  #      summarise(count = length(coverage)) %>% 
  ggpubr::ggbarplot(., x = "Day_of_Treatment", y = "coverage",
                    fill = "grey20", color = "grey5", width = 0.8, add = "segments") + #,
  # ylab = "gdh copies / 10^10 cells \n", xlab = "") +
  # facet_grid(variable ~ ., scales = "free") +
  # ggplot(., aes(x=Day_of_Treatment, y=coverage)) +
  # geom_point() +
  ggpubr::rotate_x_text(60)  +
  theme_light() + 
  facet_grid(Model ~   Model2+ Fermentation + Reactor_Treatment_Dose, scales = "free", space = "free") -> repr_top_Fam_donor_grp
# facet_grid(Model ~  Model2 + Reactor_Treatment_Dose_fermentation,  scales = "fixed", space = "fixed", drop = TRUE) -> toto
# facet_grid(Model ~  Model2 + Fermentation + Reactor_Treatment_Dose, scales = "free", space = "free", drop = FALSE) -> toto
# facet_wrap()

repr_top_Fam_donor_grp
```

### Genus:

top  per fecal samples in each donors:

```{r}
ntax = 10

before_treat %>%
  subset_samples(Reactor == "DONOR") %>% 
  physeq_most_abundant(group_var = "Model2",
                       ntax = ntax,
                       tax_level = "Genus") -> top_gen_donor_feces

# top_ASV_donor_feces

before_treat %>%
  physeq_most_abundant(group_var = "Reactor",
                       ntax = ntax,
                       tax_level = "Genus") -> top_gen_group

# top_ASV_group
```


```{r}
before_treat %>%
  filter_taxa(function(x) sum(x > 0) > 0, TRUE) %>% 
  # subset_samples(Model2 == "Chicken1") %>% 
  # subset_samples(Reactor == "DONOR") %>%  sample_data() %>%  data.frame()
  speedyseq::tax_glom(taxrank = "Genus") %>%
  transform_sample_counts(function(x) x/sum(x) * 100) %>%
  subset_taxa(Genus %in% top_gen_donor_feces) %>% # extract only the taxa to display - after percentage normalisation
  
  phyloseq_ampvis_heatmap(physeq = ., tax_aggregate = "Genus",
                          transform = FALSE,
                          plot_values = FALSE,
                          facet_by = c("Model2", "Model", "Fermentation","Reactor_Treatment_Dose"),
                          group_by = "Day_of_Treatment",#"sample_name",
                          ntax = Inf
  ) -> pre_gen

pre_gen$data %>% 
  mutate(Abundance = na_if(Abundance, 0)) %>% 
  mutate(Fermentation = Fermentation %>%  as.character() %>%  replace_na(., "NA")) %>% 
  mutate(Fermentation = factor(Fermentation, levels = c("NA", 1, 2))) -> pre_gen$data 


pre_gen + 
  facet_grid(Model ~  Model2 + Fermentation + Reactor_Treatment_Dose, scales = "free", space = "free") +
  scale_color_manual(values = c("#31a354", "orange", 
                                "#f03b20"), drop = FALSE, na.value = 'transparent') -> pre_gen


pre_gen
```
```{r}

before_treat %>%
  filter_taxa(function(x) sum(x > 0) > 0, TRUE) %>% 
  transform_sample_counts(function(x) x/sum(x) * 100) %>%
  subset_taxa(Genus %in% top_gen_donor_feces) %>% 
  ps_arrange(Day_of_Treatment) %>% 
  speedyseq::psmelt() %>%
  # group_by(Sample, Day_of_Treatment, Fermentation, Model, Model2, Reactor_Treatment_Dose) %>%
  group_by(sample_names, Model, Model2, Day_of_Treatment, Fermentation , Reactor_Treatment_Dose) %>% 
  summarise(coverage = sum(Abundance)) %>%
  ungroup() %>%
  mutate(Day_of_Treatment = as.double(Day_of_Treatment)) %>%
  # mutate_at(vars(Day_of_Treatment), ~replace_na(., 0)) %>%
  arrange(Day_of_Treatment) %>%
  # group_by(sample_names, Model, Model2, Day_of_Treatment, Reactor_Treatment_Dose_fermentation) %>% 
  #      summarise(count = length(coverage)) %>% 
  ggpubr::ggbarplot(., x = "Day_of_Treatment", y = "coverage",
                    fill = "grey20", color = "grey5", width = 0.8, add = "segments") + #,
  # ylab = "gdh copies / 10^10 cells \n", xlab = "") +
  # facet_grid(variable ~ ., scales = "free") +
  # ggplot(., aes(x=Day_of_Treatment, y=coverage)) +
  # geom_point() +
  ggpubr::rotate_x_text(60)  +
  theme_light() + 
  facet_grid(Model ~  Model2 + Fermentation + Reactor_Treatment_Dose, scales = "free", space = "free") -> repr_top_gen_donor_feces
# facet_grid(Model ~  Model2 + Reactor_Treatment_Dose_fermentation,  scales = "fixed", space = "fixed", drop = TRUE) -> toto
# facet_grid(Model ~  Model2 + Fermentation + Reactor_Treatment_Dose, scales = "free", space = "free", drop = FALSE) -> toto
# facet_wrap()

repr_top_gen_donor_feces
```


```{r}
before_treat %>%
  filter_taxa(function(x) sum(x > 0) > 0, TRUE) %>% 
  # subset_samples(Model2 == "Chicken1") %>% 
  # subset_samples(Reactor == "DONOR") %>%  sample_data() %>%  data.frame()
  speedyseq::tax_glom(taxrank = "Genus") %>%
  transform_sample_counts(function(x) x/sum(x) * 100) %>%
  subset_taxa(Genus %in% top_gen_group) %>% # extract only the taxa to display - after percentage normalisation
  
  phyloseq_ampvis_heatmap(physeq = ., tax_aggregate = "Genus",
                          transform = FALSE,
                          plot_values = FALSE,
                          facet_by = c("Model2", "Model", "Fermentation","Reactor_Treatment_Dose"),
                          group_by = "Day_of_Treatment",#"sample_name",
                          ntax = Inf
  ) -> pre_gen_grp

pre_gen_grp$data %>% 
  mutate(Abundance = na_if(Abundance, 0)) %>% 
  mutate(Fermentation = Fermentation %>%  as.character() %>%  replace_na(., "NA")) %>% 
  mutate(Fermentation = factor(Fermentation, levels = c("NA", 1, 2))) -> pre_gen_grp$data 


pre_gen_grp + 
  facet_grid(Model ~  Model2 + Fermentation + Reactor_Treatment_Dose, scales = "free", space = "free") +
  scale_color_manual(values = c("#31a354", "orange", 
                                "#f03b20"), drop = FALSE, na.value = 'transparent') -> pre_gen_grp


pre_gen_grp
```
```{r}

before_treat %>%
  filter_taxa(function(x) sum(x > 0) > 0, TRUE) %>% 
  transform_sample_counts(function(x) x/sum(x) * 100) %>%
  subset_taxa(Genus %in% top_gen_group) %>% 
  ps_arrange(Day_of_Treatment) %>% 
  speedyseq::psmelt() %>%
  # group_by(Sample, Day_of_Treatment, Fermentation, Model, Model2, Reactor_Treatment_Dose) %>%
  group_by(sample_names, Model, Model2, Day_of_Treatment , Fermentation,  Reactor_Treatment_Dose) %>% 
  summarise(coverage = sum(Abundance)) %>%
  ungroup() %>%
  mutate(Day_of_Treatment = as.double(Day_of_Treatment)) %>%
  # mutate_at(vars(Day_of_Treatment), ~replace_na(., 0)) %>%
  arrange(Day_of_Treatment) %>%
  # group_by(sample_names, Model, Model2, Day_of_Treatment, Reactor_Treatment_Dose_fermentation) %>% 
  #      summarise(count = length(coverage)) %>% 
  ggpubr::ggbarplot(., x = "Day_of_Treatment", y = "coverage",
                    fill = "grey20", color = "grey5", width = 0.8, add = "segments") + #,
  # ylab = "gdh copies / 10^10 cells \n", xlab = "") +
  # facet_grid(variable ~ ., scales = "free") +
  # ggplot(., aes(x=Day_of_Treatment, y=coverage)) +
  # geom_point() +
  ggpubr::rotate_x_text(60)  +
  theme_light() + 
  facet_grid(Model ~  Model2 + Fermentation + Reactor_Treatment_Dose, scales = "free", space = "free") -> repr_top_gen_donor_grp
# facet_grid(Model ~  Model2 + Reactor_Treatment_Dose_fermentation,  scales = "fixed", space = "fixed", drop = TRUE) -> toto
# facet_grid(Model ~  Model2 + Fermentation + Reactor_Treatment_Dose, scales = "free", space = "free", drop = FALSE) -> toto
# facet_wrap()

repr_top_gen_donor_grp
```
## gram plots:

histogram of gram+ gram- & intrinsicly resistant or not an annotation color in a heatmap would be cool as well.

```{r}
"data/processed/16S/16S_based_gram.RDS" %>% 
  here::here() %>% 
  readRDS() -> gram

gram %>% 
  summarise_all(~ sum(is.na(.)))
```

```{r}
dim(gram)

intersect(gram$ASV,
          tax_table(ps_filtered)[,"Strain"] %>%  as.character() ) %>%  length() 
```

Let's take the Class info here.

## intrinsic:

```{r}
"data/processed/16S/16S_based_intrinsinc_AMR.RDS" %>% 
  here::here() %>% 
  readRDS() -> intrinsic_AMR
```

Wich level to chose? the one with less NA:

```{r}
intrinsic_AMR %>% 
  select(starts_with("intrinsic")) %>% 
  summary()
```

Let's take the Strain info here.

```{r}
ps_rare_gram_int <- before_treat

# We want sample, reactor..., day_0f_treatment 
ps_rare_gram_int %>% 
  tax_table() %>% 
  data.frame() %>% 
  rownames_to_column("ASVid") %>% 
  left_join(gram %>% dplyr::rename("Strain" = "ASV") %>%  
              select(Strain , gram_neg_class)
  ) %>%  #,
  # by = c("Strain" = "ASV"),
  # suffix = c("", ".y")) %>% 
  select(ASVid:Strain, gram_neg_class) %>% 
  dplyr::rename('gram_stain' = 'gram_neg_class') %>% 
  mutate(gram_stain = replace_na(gram_stain, "unknown-gram")) %>% 
  left_join(., intrinsic_AMR,
            suffix = c("", ".y"),
            by = c("Strain" = "ASV")) %>%
  mutate(intrinsic = ifelse(intrinsic_strain_van == TRUE & intrinsic_strain_ctx == TRUE, "intrinsic-VAN-CTX",  ifelse(intrinsic_strain_van == TRUE, "intrinsic-VAN", ifelse(intrinsic_strain_ctx == TRUE, "intrinsic-CTX", "No-intrinsic")))) %>% 
  select(ASVid:gram_stain,intrinsic) %>%
  mutate(gram_intrinsic = paste0(gram_stain, 
                                 ifelse(is.na(intrinsic), "", paste0("_",intrinsic)))) %>% 
  # dplyr::rename('intrinsic_CTX' = 'intrinsic_strain_ctx',
  # 'intrinsic_VAN' = 'intrinsic_strain_van') %>% 
  column_to_rownames('ASVid') %>% 
  as.matrix() -> tax_table(ps_rare_gram_int)


# ps_rare_gram_int %>% 
#   phloseq_export_otu_tax() %>% 
#   select(-ASV_sequence) %>% 
#     xlsx::write.xlsx(file = out_xlsx,
#                    append = TRUE,
#                    sheetName = "gram_classification",
#                    showNA = TRUE)
```


```{r}
require(microViz)

ps_rare_gram_int %>% 
  subset_samples(sample_name %in% c(before_treat_samples)) %>% 
  # subset_samples(Model2 == "Chicken2" & Treatment != "DONOR" & Day_of_Treatment >= -1) %>% 
  # microViz::ps_mutate(Reactor_Treatment_Dose = paste0(Reactor_Treatment_Dose, "_", Fermentation)) %>% 
  # microViz::ps_mutate(Treatment = fct_relevel(Treatment, sample_data(ps_rare)$Treatment %>%  levels())) %>% 
  transform_sample_counts(function(x) x/sum(x) * 100) %>%
  physeq_sel_tax_table(c("gram_stain")) %>% 
  speedyseq::tax_glom("gram_stain") %>% 
  speedyseq::psmelt() %>% 
  arrange(-Day_of_Treatment) %>% 
  ggpubr::ggbarplot(., x = "Day_of_Treatment", y = "Abundance", 
                    fill = "gram_stain", width = 0.8) + #,
  # ylab = "gdh copies / 10^10 cells \n", xlab = "") +
  # facet_grid(variable ~ ., scales = "free") + 
  ggpubr::rotate_x_text(60)  + 
  scale_color_manual(values  =   microViz::distinct_palette(3, pal = "greenArmytage")) +
  scale_fill_manual(values  =   microViz::distinct_palette(3, pal = "greenArmytage")) +
  theme_light() + facet_grid(Model ~  Model2 + Fermentation + Reactor_Treatment_Dose, scales = "free", space = "free_x", drop = TRUE) 
# scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
#               labels = trans_format("log10", math_format(10^.x))) 

```

## alpha div plots:

```{r}
before_treat %>% 
  phyloseq_alphas(physeq = ., phylo = FALSE, compute_NTI_PD = TRUE, export_hill = TRUE, return = "long") -> a_div

a_div %>% 
  filter(! alphadiversiy %in% c("diversity_coverage", "evenness_pielou", "Hill-d1",  "Hill-d2") ) %>% 
  mutate(alphadiversiy = fct_relevel(alphadiversiy, c("Hill-d0"))) %>%
  ggpubr::ggbarplot(., x = "Day_of_Treatment", y = "value",
                    fill = "grey20", color = "grey5", width = 0.8, add = "segments") + #,
  # ylab = "gdh copies / 10^10 cells \n", xlab = "") +
  # facet_grid(variable ~ ., scales = "free") +
  # ggplot(., aes(x=Day_of_Treatment, y=coverage)) +
  # geom_point() +
  ggpubr::rotate_x_text(60)  +
  theme_light() + 
  facet_grid(alphadiversiy ~  Model2  +  Reactor_Treatment_Dose, scales = "free", space = "free_x") -> alpha_hist
# mutate(Day_of_Treatment = sort(Day_of_Treatment)) %>% 
# ggplot(data = .,
#        mapping = aes(x = "Day_of_Treatment", y = "value")) +
# ggpubr::ggdotchart(., x = "Day_of_Treatment", y = "value", 
#                    fill = "grey20", color = "grey5", width = 0.8, add = "segments") + 

# ggplot(aes(x = Day_of_Treatment, y = value)) +
# geom_point(color = "grey20") +
# ggpubr::rotate_x_text(60)  + 
# theme_light() + facet_grid(alphadiversiy ~  Model2 + Fermentation + Reactor_Treatment_Dose, scales = "free", space = "free_x", drop = TRUE) -> alpha_hist
# scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
#               labels = trans_format("log10", math_format(10^.x))) 

alpha_hist


# alpha_hist %>% 
#   export::graph2ppt(append = TRUE, 
#                     width = 317.48031496 * 2.5, 
#                     height = 0.618 * 317.48031496 * 1 , paper = "A4",  scaling = 2,
#                     file = out_pptx)
```

# Export - plots:

## vs per rector

```{r}
ggpubr::ggarrange(alpha_hist +
                    theme(legend.position = "null") +
                    theme(axis.title.x=element_blank(),
                          axis.text.x=element_blank(),
                          axis.ticks.x=element_blank()),
                  pre_Family_grp + theme(
                    strip.background = element_blank(),
                    strip.text.x = element_blank(),
                    legend.position = "null",
                    axis.title.x=element_blank(),
                    axis.text.x=element_blank(),
                    axis.ticks.x=element_blank()),
                  pre_gen_grp + theme(
                    strip.background = element_blank(),
                    strip.text.x = element_blank(),
                    legend.position = "null",
                    axis.title.x=element_blank(),
                    axis.text.x=element_blank(),
                    axis.ticks.x=element_blank()),
                  repr_top_gen_donor_grp + theme(
                    strip.background = element_blank(),
                    strip.text.x = element_blank(),
                    legend.position = "null",
                    axis.title.x=element_blank(),
                    axis.text.x=element_blank(),
                    axis.ticks.x=element_blank()),
                  pre_speces_group + theme(
                    strip.background = element_blank(),
                    strip.text.x = element_blank(),
                    legend.position = "null",
                    axis.title.x=element_blank(),
                    axis.text.x=element_blank(),
                    axis.ticks.x=element_blank()),
                  repr_top_ASV_pre_speces_group + theme(
                    strip.background = element_blank(),
                    strip.text.x = element_blank()
                  )  + theme(legend.position = "null"),
                  align = "v",
                  ncol = 1,
                  heights = c(0.75, 1, 1.5 ,0.3 , 3.75, 0.6),
                  common.legend = FALSE) -> pre_plots_grp


pre_plots_grp

pre_plots_grp %>%
  ggsave(file="~/Desktop/16S-chick_Fig1b.svg", plot=., width=8, height=10)

# pre_plots_grp %>% 
#   export::graph2ppt(append = TRUE, 
#                     width = 317.48031496 * 6, 
#                     height = 0.618 * 317.48031496 * 8 , paper = "A2",  scaling = 2,
#                     file = out_pptx)
# 

# alpha_hist$data %>%
#   select(alphadiversiy, sample_name, value,Reactor_Treatment_Dose) %>%
#   pivot_wider(names_from = alphadiversiy, values_from = value) %>%
#   xlsx::write.xlsx(file = out_xlsx,
#                    append = TRUE,
#                    sheetName = "pre_alpha",
#                    showNA = TRUE)

pre_Family_grp$data %>%
  select(Display, Sample, Abundance,Reactor_Treatment_Dose) %>%
  pivot_wider(names_from = Display, values_from = Abundance) %>%
  xlsx::write.xlsx(file = out_xlsx,
                   append = TRUE,
                   sheetName = "pre_family_grp",
                   showNA = TRUE)

pre_gen_grp$data %>%
  select(Display, Sample, Abundance,Reactor_Treatment_Dose) %>%
  pivot_wider(names_from = Display, values_from = Abundance) %>%
  xlsx::write.xlsx(file = out_xlsx,
                   append = TRUE,
                   sheetName = "pre_gen_grp",
                   showNA = TRUE)

repr_top_gen_donor_grp$data %>%
  select(sample_names, coverage,Reactor_Treatment_Dose) %>%
  # pivot_wider(names_from = sample_names, values_from = coverage) %>%
  xlsx::write.xlsx(file = out_xlsx,
                   append = TRUE,
                   sheetName = "pre_gen_rep_grp",
                   showNA = TRUE)


pre_speces_group$data %>%
  select(Display, Sample, Abundance,Reactor_Treatment_Dose) %>%
  pivot_wider(names_from = Display, values_from = Abundance) %>%
  xlsx::write.xlsx(file = out_xlsx,
                   append = TRUE,
                   sheetName = "pre_ASV_grp",
                   showNA = TRUE)


repr_top_ASV_pre_speces_group$data %>%
  select(sample_names, coverage,Reactor_Treatment_Dose) %>%
  # pivot_wider(names_from = sample_names, values_from = coverage) %>%
  xlsx::write.xlsx(file = out_xlsx,
                   append = TRUE,
                   sheetName = "pre_rep_ASV_grp",
                   showNA = TRUE)

```


## top vs feces:

```{r}
ggpubr::ggarrange(alpha_hist + ylab(NULL) + scale_y_continuous(breaks = c(0, 75, 150),  labels = c(0, 75, 150)) + 
                    theme(legend.position = "null") + 
                    theme(axis.title.x=element_blank(),
                          axis.text.x=element_blank(),
                          axis.ticks.x=element_blank()),
                  pre_Family + ylab(NULL) + theme(
                    strip.background = element_blank(),
                    strip.text.x = element_blank(),
                    legend.position = "null",
                    axis.title.x=element_blank(),
                    axis.text.x=element_blank(),
                    axis.ticks.x=element_blank()),
                  pre_gen + ylab(NULL) + theme(
                    strip.background = element_blank(),
                    strip.text.x = element_blank(),
                    legend.position = "null",
                    axis.title.x=element_blank(),
                    axis.text.x=element_blank(),
                    axis.ticks.x=element_blank()),
                  repr_top_gen_donor_feces + ylab(NULL) + scale_y_continuous(breaks = c(0, 50, 100),  labels = c(0, 50, 100)) + theme(
                    strip.background = element_blank(),
                    strip.text.x = element_blank(),
                    legend.position = "null",
                    axis.title.x=element_blank(),
                    axis.text.x=element_blank(),
                    axis.ticks.x=element_blank()),
                  pre_speces_feces + ylab(NULL) + theme(
                    strip.background = element_blank(),
                    strip.text.x = element_blank(),
                    legend.position = "null",
                    axis.title.x=element_blank(),
                    axis.text.x=element_blank(),
                    axis.ticks.x=element_blank()),
                  repr_top_ASV_donor_feces  + ylab(NULL) + scale_y_continuous(breaks = c(0, 50, 100),  labels = c(0, 50, 100)) + theme(
                    strip.background = element_blank(),
                    strip.text.x = element_blank()
                  )  + theme(legend.position = "null"),
                  align = "v",
                  ncol = 1, 
                  nrow = 6,
                  # heights = c(1, 1, 1 ,0.25 , 2.5, 0.5),
                  heights = c(2, 2.75, 3 , 1 , 6.25, 1.5),
                  common.legend = TRUE) -> pre_plots

pre_plots

pre_plots %>% 
  ggsave(file="~/Desktop/16S-chick_Fig1.svg", plot=., width=10, height=8)

pre_plots %>% 
  export::graph2ppt(append = TRUE, 
                    width = 317.48031496 * 6, 
                    height = 0.618 * 317.48031496 * 8 , paper = "A3",  scaling = 2,
                    file = out_pptx)


# alpha_hist$data %>% 
#   select(alphadiversiy, sample_name, value,Reactor_Treatment_Dose) %>% 
#   pivot_wider(names_from = alphadiversiy, values_from = value) %>% 
#   xlsx::write.xlsx(file = out_xlsx,
#                    append = TRUE,
#                    sheetName = "pre_alpha",
#                    showNA = TRUE)

pre_Family$data %>% 
  select(Display, Sample, Abundance,Reactor_Treatment_Dose) %>% 
  pivot_wider(names_from = Display, values_from = Abundance) %>% 
  xlsx::write.xlsx(file = out_xlsx,
                   append = TRUE,
                   sheetName = "pre_family",
                   showNA = TRUE)

pre_gen$data %>% 
  select(Display, Sample, Abundance,Reactor_Treatment_Dose) %>% 
  pivot_wider(names_from = Display, values_from = Abundance) %>% 
  xlsx::write.xlsx(file = out_xlsx,
                   append = TRUE,
                   sheetName = "pre_gen",
                   showNA = TRUE)

repr_top_gen_donor_feces$data %>% 
  select(sample_names, coverage,Reactor_Treatment_Dose) %>% 
  # pivot_wider(names_from = sample_names, values_from = coverage) %>% 
  xlsx::write.xlsx(file = out_xlsx,
                   append = TRUE,
                   sheetName = "pre_gen_rep",
                   showNA = TRUE)


pre_speces_feces$data %>% 
  select(Display, Sample, Abundance,Reactor_Treatment_Dose) %>% 
  pivot_wider(names_from = Display, values_from = Abundance) %>% 
  xlsx::write.xlsx(file = out_xlsx,
                   append = TRUE,
                   sheetName = "pre_ASV",
                   showNA = TRUE)


repr_top_ASV_donor_feces$data %>% 
  select(sample_names, coverage,Reactor_Treatment_Dose) %>% 
  # pivot_wider(names_from = sample_names, values_from = coverage) %>% 
  xlsx::write.xlsx(file = out_xlsx,
                   append = TRUE,
                   sheetName = "pre_rep_ASV",
                   showNA = TRUE)

```
two feces plot:



```{r}
before_treat %>% 
  subset_samples(Treatment == "DONOR" ) %>% 
  filter_taxa(function(x) sum(x > 0) > 0, TRUE) %>% 
  # microViz::ps_mutate(Reactor_Treatment_Dose = paste0(Reactor_Treatment_Dose, "_", Fermentation)) %>% 
  transform_sample_counts(function(x) x/sum(x) * 100) %>%
  microViz::phyloseq_validate() %>%
  microViz::tax_fix() %>% 
  microViz::ps_arrange(Day_of_Treatment) %>% 
  microViz::comp_barplot(
    tax_transform_for_plot = "identity",
    tax_level = "Family",
    label = "Model2", # name an alternative variable to label axes
    n_taxa = 20, # give more taxa unique colours
    palette = microViz::distinct_palette(20, pal = "kelly"),
    merge_other = FALSE, # split the "other" category to display alpha diversity
    bar_width = 0.9, # reduce the bar width to 70% of one row
    bar_outline_colour = "grey5",
    sample_order = "default") +
  ylab("Proportion - %") + xlab( " Donor ") -> p_hist

p_hist + facet_grid(. ~ Reactor_Treatment_Dose, scales = "free", space = "free_x", drop = TRUE) -> p_hist_human1_fam

p_hist_human1_fam  +  theme_light() + theme(legend.position = "none") -> p_hist_human1_fam_no_leg

p_hist_human1_fam_no_leg

p_hist_human1_fam %>%  
  ggpubr::get_legend() %>% 
  ggpubr::as_ggplot() -> p_hist_human1_fam_leg
```

```{r}
hueRank <- "Phylum"
hueRankPlural <- "Phyla"
shadeRank <- "Family"

# Sort phyloseq at lower, and then higher ranks
pseq2 <- 
  before_treat %>% 
  subset_samples(Treatment == "DONOR" ) %>% 
  filter_taxa(function(x) sum(x > 0) > 0, TRUE) %>% 
  # microViz::ps_mutate(Reactor_Treatment_Dose = paste0(Reactor_Treatment_Dose, "_", Fermentation)) %>% 
  transform_sample_counts(function(x) x/sum(x) * 100) %>%
  microViz::phyloseq_validate() %>%
  microViz::tax_fix() %>%
  tax_sort(by = sum, at = shadeRank) %>%
  tax_sort(by = sum, at = hueRank) %>%
  tax_agg(rank = shadeRank)

# Specify number of hues and shades desired
nHues <- 3 # "Other" phyla will be shades of grey
nShades <- 4 # "Other" families will be the lightest shade of each hue

hierarchicalPalInfo <- data.frame(
  hue = as.vector(tt_get(pseq2)[, hueRank]),
  shade = as.vector(tt_get(pseq2)[, shadeRank]),
  counts = taxa_sums(otu_get(pseq2))
)

hierarchicalPalInfo <- hierarchicalPalInfo %>%
  dplyr::mutate(
    hue = forcats::fct_other(
      f = hue, keep = unique(hue)[seq_len(nHues)],
      other_level = paste("Other", hueRankPlural)
    ),
    nChrHue = nchar(as.character(hue)), padHue = max(nChrHue) - nChrHue
  ) %>%
  dplyr::group_by(hue) %>%
  dplyr::mutate(
    shade = forcats::fct_other(
      f = shade, keep = unique(shade)[seq_len(nShades - 1)],
      other_level = "Other"
    )
  ) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(
    nChrShade = nchar(as.character(shade)), padShade = max(nChrShade) - nChrShade,
    Taxa = paste0(hue, ": ", strrep(" ", padHue), shade, strrep(" ", padShade))
  )


hierarchicalPalMatrix <- matrix(
  data = sapply(
    X = seq(from = 30, to = 75, length.out = nShades),
    FUN = function(l) scales::hue_pal(l = l, h.start = 30)(n = nHues)
  ),
  byrow = TRUE, ncol = nHues
)
hierarchicalPalMatrix <- cbind(hierarchicalPalMatrix, grey.colors(n = nShades))

hierarchicalPal <- hierarchicalPalMatrix %>%
  as.vector() %>%
  setNames(unique(hierarchicalPalInfo$Taxa))

tax_palette_plot(hierarchicalPal) +
  theme(axis.text.y.left = element_text(family = "mono"))



```
```{r}

pseq2 %>%
  ps_get() %>%
  tax_mutate("Phylum: Family" = hierarchicalPalInfo$Taxa, .keep = "none") %>%
  comp_barplot(
    label = "Model2",     merge_other = FALSE,     tax_transform_for_plot = "identity",
    tax_level = "Phylum: Family", n_taxa = length(hierarchicalPal),
    tax_order = "asis", palette = hierarchicalPal, bar_width = 0.975
  ) +
  # coord_flip() +
  theme(legend.text = element_text(family = "mono")) + ylab("Proportion") -> plot_tmp# for text alignment

plot_tmp


# plot_tmp + facet_grid(Phylum ~ ., scales = "free", space = "free_x", drop = TRUE) 

plot_tmp  +  theme_light() + theme(legend.position = "none") -> plot_tmp_noleg

plot_tmp_noleg %>% 
  ggsave(file="~/Desktop/16S-chick_FigS1.svg", plot=., width=2, height=3)

plot_tmp_noleg %>% 
  export::graph2ppt(append = TRUE, 
                    width = 317.48031496  / 3, 
                    height = 0.618 * 317.48031496 , paper = "A4",  scaling = 2,
                    file = out_pptx)

plot_tmp %>%  
  ggpubr::get_legend() %>% 
  ggpubr::as_ggplot() -> plot_tmp_leg

plot_tmp_leg %>% 
  export::graph2ppt(append = TRUE, 
                    width = 317.48031496 , 
                    height = 0.618 * 317.48031496  , paper = "A4",  scaling = 2,
                    file = out_pptx)
```


```{r}

pseq2 %>%
  ps_get() %>%
  tax_mutate("Phylum: Family" = hierarchicalPalInfo$Taxa, .keep = "none") %>%
  comp_barplot(
    label = "Model2",     merge_other = FALSE,     tax_transform_for_plot = "identity",
    tax_level = "Phylum: Family", n_taxa = length(hierarchicalPal),
    tax_order = "asis", palette = hierarchicalPal, bar_width = 0.975
  ) +
  # coord_flip() +
  theme(legend.text = element_text(family = "mono")) + ylab("Proportion") -> plot_tmp# for text alignment

plot_tmp


# plot_tmp + facet_grid(Phylum ~ ., scales = "free", space = "free_x", drop = TRUE) 

plot_tmp  +  theme_light() + theme(legend.position = "none") -> plot_tmp_noleg

plot_tmp_noleg %>% 
  ggsave(file="~/Desktop/16S-chick_FigS1.svg", plot=., width=2, height=3)

plot_tmp_noleg %>% 
  export::graph2ppt(append = TRUE, 
                    width = 317.48031496  / 3, 
                    height = 0.618 * 317.48031496 , paper = "A4",  scaling = 2,
                    file = out_pptx)

plot_tmp %>%  
  ggpubr::get_legend() %>% 
  ggpubr::as_ggplot() -> plot_tmp_leg

plot_tmp_leg %>% 
  export::graph2ppt(append = TRUE, 
                    width = 317.48031496 , 
                    height = 0.618 * 317.48031496  , paper = "A4",  scaling = 2,
                    file = out_pptx)
```


```{r}
require(tidyverse); require(phyloseq)
min_sample_size = 3738
taxrank = "Class"

url("https://github.com/fconstancias/NRP72-FBT/blob/master/data/processed/16S/16S_working_phyloseq.RDS?raw=true")%>% 
  readRDS()  %>% 
  subset_samples(Enrichment == "NotEnriched") %>%
  subset_samples(Experiment %in% c("Continuous", "Cecum")) %>%
  subset_samples(Day_of_Treatment > -6 & Day_of_Treatment <= 30 | Reactor == "DONOR") %>% 
  subset_samples(Model == "Chicken") %>% 
  subset_samples(Reactor != "CR" & Model2 == "Chicken1" | Model2 == "Chicken2" & Reactor %in% c("TR2", "TR3", "TR4", "TR5", "TR6", "TR7", "CR", "DONOR")) %>% 
  subset_samples(Reactor != "IR") %>%
  filter_taxa(function(x) sum(x > 0) > 0, TRUE) %>% 
  rarefy_even_depth(sample.size = min_sample_size, rngseed = 123) %>% 
  # subset_samples(Reactor == "DONOR" & Model == "Chicken") %>% 
  tax_glom(.,  taxrank = eval(taxrank)) %>% 
  # tax_glom(taxrank = taxrank) %>% 
  transform_sample_counts(function(x) x/sum(x) * 100) -> ps_tmp

as(tax_table(ps_tmp), "matrix") %>% 
  as.data.frame() %>%
  rownames_to_column('ASV') -> tax

as(otu_table(ps_tmp), "matrix") %>% 
  as.data.frame() %>%
  rownames_to_column('ASV') -> otu

otu %>% 
  left_join(tax) %>% 
  # physeq_glom_rename(taxrank = "Strain", rename_ASV = FALSE) %>% 
  write_tsv(paste0("~/Desktop/",taxrank,"_chicken_donors.tsv"))


ps_tmp %>% 
  sample_data() %>% 
  data.frame() %>% 
    write_tsv(paste0("~/Desktop/metadata_chicken.tsv"))

  
```


```{r}
sessionInfo()
```
